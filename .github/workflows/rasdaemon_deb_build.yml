name: build-deb

on:
  push:
  pull_request:

env:
  # in 2024 Aug, Github Action provides 4 cores / 16G memory / 19G disk
  # see "default github action resource" below
  RELEASE: "sid"
  CPU: "2"
  MEMORY: "8GB"
  DISK: "16GB"
  USERNAME_IN_LXC: "tai"

jobs:
  VERIFICATION_01_LOCAL_ENV_Build_Deb_in_LXD_VM:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Variables
        run: |
          # workaround for variable substition in variable
          # https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/variables#passing-values-between-steps-and-jobs-in-a-workflow
          echo "VM=rasdaemon-${RELEASE}-vm-01" >> $GITHUB_ENV
          echo "HOME_IN_LXC=/home/${USERNAME_IN_LXC}" >> $GITHUB_ENV
          echo "LXC_CMD_PREFIX=su --login ${USERNAME_IN_LXC} -c" >> $GITHUB_ENV
          echo "REPO_NAME=${{ github.event.repository.name }}" >> $GITHUB_ENV

      - name: Launch VM Instance
        run: |
          echo ${RELEASE}
          echo ${VM}
          echo ${MEMORY}
          echo ${USERNAME_IN_LXC}
          echo ${HOME_IN_LXC}
          echo ${LXC_CMD_PREFIX}
          # remove docker in case it raises issues with lxd when accessing
          # external world in a vm
          sudo iptables -L
          sudo iptables -I DOCKER-USER -i lxdbr0 -j ACCEPT
          # this line may be unnecesasry
          sudo iptables -I DOCKER-USER -o lxdbr0 -j ACCEPT
          sudo iptables -L
          sudo apt purge -y docker-ce docker-ce-cli
          sudo snap refresh lxd --channel=latest/stable
          sudo chmod o+g '/var/snap/lxd/common/lxd/unix.socket'
          lxd init --auto

          # collecting runner info
          #
          # default github action resource:
          #
          # Filesystem      Size  Used Avail Use% Mounted on
          # /dev/root        73G   54G   19G  75% /
          # tmpfs           7.9G  172K  7.9G   1% /dev/shm
          # tmpfs           3.2G  1.1M  3.2G   1% /run
          # tmpfs           5.0M     0  5.0M   0% /run/lock
          # /dev/sda15      105M  6.1M   99M   6% /boot/efi
          # /dev/sdb1        74G  4.1G   66G   6% /mnt
          # tmpfs           1.6G   12K  1.6G   1% /run/user/1001
          # tmpfs           1.0M     0  1.0M   0% /var/snap/lxd/common/ns
          #
          #                total        used        free      shared  buff/cache   available
          # Mem:            15Gi       689Mi        13Gi        23Mi       1.8Gi        14Gi
          # Swap:          4.0Gi          0B       4.0Gi
          #
          # The shell currently using:  /bin/bash
          #
          # Available CPU number: 4
          df -h
          free -hm
          echo "The shell currently using: " ${SHELL}
          echo "Available CPU number:" $(grep -c ^processor /proc/cpuinfo)
          lxc profile show default
          ip a

          # tested with lxc 6.1-c14927a
          lxc init images:debian/${RELEASE} ${VM} --vm -c limits.cpu=${CPU} -c limits.memory=${MEMORY} -d root,size=${DISK} -c security.secureboot=false
          lxc config set ${VM} limits.cpu ${CPU}
          lxc config set ${VM} limits.memory ${MEMORY}
          lxc start ${VM}

          echo "booting vm..."
          sleep 30  # `lxc start` needs a `--wait`.
          echo "booted vm."

          # collecting vm in the running info
          echo "The disk size and ip a currently using in vm: "
          lxc exec ${VM} -- df -h
          lxc exec ${VM} -- ip a

          lxc exec ${VM} -- apt update
          lxc exec ${VM} -- apt install -y cloud-guest-utils e2fsprogs
          lxc exec ${VM} -- growpart /dev/sda 2
          lxc exec ${VM} -- resize2fs /dev/sda2

          lxc exec ${VM} -- apt install -y git-buildpackage ubuntu-dev-tools debhelper

          # check if the root partition is increased
          echo "rebooting vm..."
          lxc exec ${VM} -- reboot
          sleep 30
          echo "rebooted vm."

          echo "The disk size and shell currently using in vm: "
          lxc exec ${VM} -- pwd
          lxc exec ${VM} -- df -h
          lxc exec ${VM} -- echo ${SHELL}

          # begin to setup development env
          # create normal user with sudo permission
          lxc exec ${VM} -- adduser --disabled-password --comment "" ${USERNAME_IN_LXC}
          lxc exec ${VM} -- adduser ${USERNAME_IN_LXC} sudo

          echo "======================================================"
          echo "The shell currently used in vm by ${USERNAME_IN_LXC}: "
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "echo ${SHELL}"
          echo "======================================================"

          #echo ${GITHUB_WORKSPACE}
          #ls ${GITHUB_WORKSPACE}
          #ls -alhd ${GITHUB_WORKSPACE}
          #echo ${REPO_NAME}
          lxc file push -r ${GITHUB_WORKSPACE} ${VM}/home/${USERNAME_IN_LXC}/
          #lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "ls ./"
          #lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "ls ${REPO_NAME}"
          #lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "pwd"

          lxc exec ${VM} -- ${HOME_IN_LXC}/${REPO_NAME}/debian/tools/func-setup-sudo-without-password.sh ${USERNAME_IN_LXC}

      - name: Get Ready to Setup Testbed with LXD and QEMU Tools
        run: |
          # begin to setup autopkgtest
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "${HOME_IN_LXC}/${REPO_NAME}/debian/tools/03-get-ready-to-use-autopkgtest-qemu-lxd.sh"

          # make sure USER can run lxd lxc without sudo
          lxc exec ${VM} -- snap services lxd
          # snap service prefix is snap.
          lxc exec ${VM} -- systemctl start snap.lxd.activate
          lxc exec ${VM} -- systemctl start snap.lxd.daemon
          lxc exec ${VM} -- systemctl start snap.lxd.user-daemon
          lxc exec ${VM} -- snap services lxd
          # hmmm this trick works rather than systemctl start
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "sudo usermod -a -G lxd ${USERNAME_IN_LXC}"
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "newgrp lxd"

          echo "checking /dev/kvm read/write permission..."
          lxc exec ${VM} -- apt update
          lxc exec ${VM} -- apt install -y cpu-checker
          lxc exec ${VM} -- kvm-ok
          lxc exec ${VM} -- adduser ${USERNAME_IN_LXC} kvm
          lxc exec ${VM} -- kvm-ok
          echo "checking /dev/kvm read/write permission... done!"

          # make sure USER can know the /snap/bin/lxd path
          # make sure USER can have lxd group permission
          echo "rebooting vm..."
          lxc exec ${VM} -- reboot
          sleep 30
          echo "rebooted vm."

          # get lxd-managed lxc command ready to use
          lxc exec ${VM} -- lxd init --auto

      - name: Build Deb
        run: |
          # build rasdaemon deb
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "${HOME_IN_LXC}/${REPO_NAME}/debian/tools/02-fetch-and-build-rasdaemon-deb-src.sh"

      - name: Run Test - Autopkgtest Local Env
        run: |
          # start testing with autopkgtest
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "${HOME_IN_LXC}/${REPO_NAME}/debian/tools/04-run-autopkgtest-local.sh"

      - name: Functional Testing
        run: |
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c 'echo ${HOME}/workspace-rasdaemon-deb/'
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c 'ls ${HOME}/workspace-rasdaemon-deb/'
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c 'sudo apt install -y ${HOME}/workspace-rasdaemon-deb/rasdaemon_*_amd64.deb'

          lxc exec ${VM} -- bash -c 'echo "deb-src http://deb.debian.org/debian/ sid main" | tee -a /etc/apt/sources.list'
          lxc exec ${VM} -- bash -c 'apt update; apt install -y git make kmod dpkg-dev linux-headers-amd64'
          lxc exec ${VM} -- ${HOME_IN_LXC}/${REPO_NAME}/debian/tools/build-run-fake-edac-ko-sid-02-build-run.sh
          # still WIP
          #lxc exec ${VM} -- ${HOME_IN_LXC}/toolbox/scripts/packaging-deb-rasdaemon/run-test_02-inject-fake-events.sh
          lxc exec ${VM} -- ras-mc-ctl --summary
          lxc exec ${VM} -- ras-mc-ctl --errors
          lxc exec ${VM} -- ras-mc-ctl --status
          lxc exec ${VM} -- systemctl is-active --quiet rasdaemon
          lxc exec ${VM} -- ${HOME_IN_LXC}/${REPO_NAME}/debian/tools/run-test_01-show-general-info.sh
          # single quote matters to ensure the cat command is interpretered at the right stage.
          lxc exec ${VM} -- bash -c 'echo mc_name is: $(sudo cat /sys/devices/system/edac/mc/mc0/mc_name)'

      #- name: Setup Testbed - Bare Metal and Linux Kernel with Debugfs Enabled
      #  run: |
      #    lxc exec ${VM} -- apt install wireless-regdb
      #    lxc exec ${VM} -- wget https://people.canonical.com/~taihsiang/rasdaemon-amd64/linux-debugfs-enabled/linux-image-unsigned-5.15.0-27-generic_5.15.0-27.28~d20220513t004517~ab2e786e8b1e_amd64.deb
      #    lxc exec ${VM} -- wget https://people.canonical.com/~taihsiang/rasdaemon-amd64/linux-debugfs-enabled/linux-modules-5.15.0-27-generic_5.15.0-27.28~d20220513t004517~ab2e786e8b1e_amd64.deb
      #    lxc exec ${VM} -- wget https://people.canonical.com/~taihsiang/rasdaemon-amd64/linux-debugfs-enabled/linux-modules-extra-5.15.0-27-generic_5.15.0-27.28~d20220513t004517~ab2e786e8b1e_amd64.deb
      #    lxc exec ${VM} -- dpkg -i linux-image-unsigned-5.15.0-27-generic_5.15.0-27.28~d20220513t004517~ab2e786e8b1e_amd64.deb linux-modules-5.15.0-27-generic_5.15.0-27.28~d20220513t004517~ab2e786e8b1e_amd64.deb linux-modules-extra-5.15.0-27-generic_5.15.0-27.28~d20220513t004517~ab2e786e8b1e_amd64.deb
      #    lxc exec ${VM} -- uname -a

      #    lxc exec ${VM} -- bash -c "awk -F\' '/menuentry / {print $2}' /boot/grub/grub.cfg"
      #    lxc exec ${VM} -- bash -c "grub-reboot '1>2'"

      #    # make the new kernel take effect
      #    echo "rebooting vm..."
      #    lxc exec ${VM} -- reboot
      #    sleep 60
      #    echo "rebooted vm."

      #    #lxc exec ${VM} -- sudo modprobe i7core_edac
      #    #lxc exec ${VM} -- sudo modprobe amd64_edac_mod
      #    #lxc exec ${VM} -- sudo modprobe i82801ca_edac

      #    lxc exec ${VM} -- bash -c "sudo dmesg | grep -i EDAC"
      #    # just dump debugging info. do not stop if nothing is found
      #    lxc exec ${VM} -- bash -c "lsmod | grep -i EDAC; true"
      #    lxc exec ${VM} -- ls /sys/devices/system/edac/mc
      #    # at this moment, I do not expect there is such fs enabled
      #    lxc exec ${VM} -- bash -c "ls /sys/kernel/debug/edac/; true"
      #    lxc exec ${VM} -- uname -a

  VERIFICATION_02_LXC_Build_Deb_in_LXD_VM:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Variables
        run: |
          # workaround for variable substition in variable
          # https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/variables#passing-values-between-steps-and-jobs-in-a-workflow
          echo "VM=rasdaemon-${RELEASE}-vm-01" >> $GITHUB_ENV
          echo "HOME_IN_LXC=/home/${USERNAME_IN_LXC}" >> $GITHUB_ENV
          echo "LXC_CMD_PREFIX=su --login ${USERNAME_IN_LXC} -c" >> $GITHUB_ENV
          echo "REPO_NAME=${{ github.event.repository.name }}" >> $GITHUB_ENV

      - name: Launch VM Instance
        run: |
          echo ${RELEASE}
          echo ${VM}
          echo ${MEMORY}
          echo ${USERNAME_IN_LXC}
          echo ${HOME_IN_LXC}
          echo ${LXC_CMD_PREFIX}
          # remove docker in case it raises issues with lxd when accessing
          # external world in a vm
          sudo iptables -L
          sudo iptables -I DOCKER-USER -i lxdbr0 -j ACCEPT
          # this line may be unnecesasry
          sudo iptables -I DOCKER-USER -o lxdbr0 -j ACCEPT
          sudo iptables -L
          sudo apt purge -y docker-ce docker-ce-cli
          sudo snap refresh lxd --channel=latest/stable
          sudo chmod o+g '/var/snap/lxd/common/lxd/unix.socket'
          lxd init --auto

          # collecting runner info
          #
          # default github action resource:
          #
          # Filesystem      Size  Used Avail Use% Mounted on
          # /dev/root        73G   54G   19G  75% /
          # tmpfs           7.9G  172K  7.9G   1% /dev/shm
          # tmpfs           3.2G  1.1M  3.2G   1% /run
          # tmpfs           5.0M     0  5.0M   0% /run/lock
          # /dev/sda15      105M  6.1M   99M   6% /boot/efi
          # /dev/sdb1        74G  4.1G   66G   6% /mnt
          # tmpfs           1.6G   12K  1.6G   1% /run/user/1001
          # tmpfs           1.0M     0  1.0M   0% /var/snap/lxd/common/ns
          #
          #                total        used        free      shared  buff/cache   available
          # Mem:            15Gi       689Mi        13Gi        23Mi       1.8Gi        14Gi
          # Swap:          4.0Gi          0B       4.0Gi
          #
          # The shell currently using:  /bin/bash
          #
          # Available CPU number: 4
          df -h
          free -hm
          echo "The shell currently using: " ${SHELL}
          echo "Available CPU number:" $(grep -c ^processor /proc/cpuinfo)
          lxc profile show default
          ip a

          # tested with lxc 6.1-c14927a
          lxc init images:debian/${RELEASE} ${VM} --vm -c limits.cpu=${CPU} -c limits.memory=${MEMORY} -d root,size=${DISK} -c security.secureboot=false
          lxc config set ${VM} limits.cpu ${CPU}
          lxc config set ${VM} limits.memory ${MEMORY}
          lxc start ${VM}

          echo "booting vm..."
          sleep 30  # `lxc start` needs a `--wait`.
          echo "booted vm."

          # collecting vm in the running info
          echo "The disk size and ip a currently using in vm: "
          lxc exec ${VM} -- df -h
          lxc exec ${VM} -- ip a

          lxc exec ${VM} -- apt update
          lxc exec ${VM} -- apt install -y cloud-guest-utils e2fsprogs
          lxc exec ${VM} -- growpart /dev/sda 2
          lxc exec ${VM} -- resize2fs /dev/sda2

          lxc exec ${VM} -- apt install -y git-buildpackage ubuntu-dev-tools debhelper

          # check if the root partition is increased
          echo "rebooting vm..."
          lxc exec ${VM} -- reboot
          sleep 30
          echo "rebooted vm."

          echo "The disk size and shell currently using in vm: "
          lxc exec ${VM} -- pwd
          lxc exec ${VM} -- df -h
          lxc exec ${VM} -- echo ${SHELL}

          # begin to setup development env
          # create normal user with sudo permission
          lxc exec ${VM} -- adduser --disabled-password --comment "" ${USERNAME_IN_LXC}
          lxc exec ${VM} -- adduser ${USERNAME_IN_LXC} sudo

          echo "======================================================"
          echo "The shell currently used in vm by ${USERNAME_IN_LXC}: "
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "echo ${SHELL}"
          echo "======================================================"

          #echo ${GITHUB_WORKSPACE}
          #ls ${GITHUB_WORKSPACE}
          #ls -alhd ${GITHUB_WORKSPACE}
          #echo ${REPO_NAME}
          lxc file push -r ${GITHUB_WORKSPACE} ${VM}/home/${USERNAME_IN_LXC}/
          #lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "ls ./"
          #lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "ls ${REPO_NAME}"
          #lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "pwd"

          lxc exec ${VM} -- ${HOME_IN_LXC}/${REPO_NAME}/debian/tools/func-setup-sudo-without-password.sh ${USERNAME_IN_LXC}

      - name: Get Ready to Setup Testbed with LXD and QEMU Tools
        run: |
          # begin to setup autopkgtest
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "${HOME_IN_LXC}/${REPO_NAME}/debian/tools/03-get-ready-to-use-autopkgtest-qemu-lxd.sh"

          # make sure USER can run lxd lxc without sudo
          lxc exec ${VM} -- snap services lxd
          # snap service prefix is snap.
          lxc exec ${VM} -- systemctl start snap.lxd.activate
          lxc exec ${VM} -- systemctl start snap.lxd.daemon
          lxc exec ${VM} -- systemctl start snap.lxd.user-daemon
          lxc exec ${VM} -- snap services lxd
          # hmmm this trick works rather than systemctl start
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "sudo usermod -a -G lxd ${USERNAME_IN_LXC}"
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "newgrp lxd"

          echo "checking /dev/kvm read/write permission..."
          lxc exec ${VM} -- apt update
          lxc exec ${VM} -- apt install -y cpu-checker
          lxc exec ${VM} -- kvm-ok
          lxc exec ${VM} -- adduser ${USERNAME_IN_LXC} kvm
          lxc exec ${VM} -- kvm-ok
          echo "checking /dev/kvm read/write permission... done!"

          # make sure USER can know the /snap/bin/lxd path
          # make sure USER can have lxd group permission
          echo "rebooting vm..."
          lxc exec ${VM} -- reboot
          sleep 30
          echo "rebooted vm."

          # get lxd-managed lxc command ready to use
          lxc exec ${VM} -- lxd init --auto

      - name: Build Deb
        run: |
          # build rasdaemon deb
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "${HOME_IN_LXC}/${REPO_NAME}/debian/tools/02-fetch-and-build-rasdaemon-deb-src.sh"

      - name: Setup Testbed - Autopkgtest LXD
        run: |
          # begin to build lxc testbed via lxd
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "echo 'building autopkgtest-build-lxd image...'"
          # dependency required since 2024 Aug 13
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "sudo apt update; sudo apt install -y dnsmasq"
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "autopkgtest-build-lxd images:debian/sid/amd64"

      - name: Run Test - Autopkgtest LXD
        # for rasdaemon
        # 1. vm as testbed is expected
        # 2. using autopkgtest in lxd-managed lxc will get return code 2
        #
        # man autopkgtest
        # 2    at least one test was skipped (or at least one flaky test failed)
        continue-on-error: true
        run: |
          # start testing with autopkgtest
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "${HOME_IN_LXC}/${REPO_NAME}/debian/tools/04-run-autopkgtest-lxd.sh"

          echo
          echo "=================================================================================================================="
          echo "rasdaemon autopkgtest expects isolation-machine. That's to say, lxd based autopkgtest will fail for return code 2:"
          echo "man autopkgtest: 2    at least one test was skipped (or at least one flaky test failed)"
          echo
          echo "Dont worry if this step fail for error code 2"
          echo "=================================================================================================================="
          echo

  VERIFICATION_03_QEMU_Build_Deb_in_LXD_VM:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Variables
        run: |
          # workaround for variable substition in variable
          # https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/variables#passing-values-between-steps-and-jobs-in-a-workflow
          echo "VM=rasdaemon-${RELEASE}-vm-01" >> $GITHUB_ENV
          echo "HOME_IN_LXC=/home/${USERNAME_IN_LXC}" >> $GITHUB_ENV
          echo "LXC_CMD_PREFIX=su --login ${USERNAME_IN_LXC} -c" >> $GITHUB_ENV
          echo "REPO_NAME=${{ github.event.repository.name }}" >> $GITHUB_ENV

      - name: Launch VM Instance
        run: |
          echo ${RELEASE}
          echo ${VM}
          echo ${MEMORY}
          echo ${USERNAME_IN_LXC}
          echo ${HOME_IN_LXC}
          echo ${LXC_CMD_PREFIX}
          # remove docker in case it raises issues with lxd when accessing
          # external world in a vm
          sudo iptables -L
          sudo iptables -I DOCKER-USER -i lxdbr0 -j ACCEPT
          # this line may be unnecesasry
          sudo iptables -I DOCKER-USER -o lxdbr0 -j ACCEPT
          sudo iptables -L
          sudo apt purge -y docker-ce docker-ce-cli
          sudo snap refresh lxd --channel=latest/stable
          sudo chmod o+g '/var/snap/lxd/common/lxd/unix.socket'
          lxd init --auto

          # collecting runner info
          #
          # default github action resource:
          #
          # Filesystem      Size  Used Avail Use% Mounted on
          # /dev/root        73G   54G   19G  75% /
          # tmpfs           7.9G  172K  7.9G   1% /dev/shm
          # tmpfs           3.2G  1.1M  3.2G   1% /run
          # tmpfs           5.0M     0  5.0M   0% /run/lock
          # /dev/sda15      105M  6.1M   99M   6% /boot/efi
          # /dev/sdb1        74G  4.1G   66G   6% /mnt
          # tmpfs           1.6G   12K  1.6G   1% /run/user/1001
          # tmpfs           1.0M     0  1.0M   0% /var/snap/lxd/common/ns
          #
          #                total        used        free      shared  buff/cache   available
          # Mem:            15Gi       689Mi        13Gi        23Mi       1.8Gi        14Gi
          # Swap:          4.0Gi          0B       4.0Gi
          #
          # The shell currently using:  /bin/bash
          #
          # Available CPU number: 4
          df -h
          free -hm
          echo "The shell currently using: " ${SHELL}
          echo "Available CPU number:" $(grep -c ^processor /proc/cpuinfo)
          lxc profile show default
          ip a

          # tested with lxc 6.1-c14927a
          lxc init images:debian/${RELEASE} ${VM} --vm -c limits.cpu=${CPU} -c limits.memory=${MEMORY} -d root,size=${DISK} -c security.secureboot=false
          lxc config set ${VM} limits.cpu ${CPU}
          lxc config set ${VM} limits.memory ${MEMORY}
          lxc start ${VM}

          echo "booting vm..."
          sleep 30  # `lxc start` needs a `--wait`.
          echo "booted vm."

          # collecting vm in the running info
          echo "The disk size and ip a currently using in vm: "
          lxc exec ${VM} -- df -h
          lxc exec ${VM} -- ip a

          lxc exec ${VM} -- apt update
          lxc exec ${VM} -- apt install -y cloud-guest-utils e2fsprogs
          lxc exec ${VM} -- growpart /dev/sda 2
          lxc exec ${VM} -- resize2fs /dev/sda2

          lxc exec ${VM} -- apt install -y git-buildpackage ubuntu-dev-tools debhelper

          # check if the root partition is increased
          echo "rebooting vm..."
          lxc exec ${VM} -- reboot
          sleep 30
          echo "rebooted vm."

          echo "The disk size and shell currently using in vm: "
          lxc exec ${VM} -- pwd
          lxc exec ${VM} -- df -h
          lxc exec ${VM} -- echo ${SHELL}

          # begin to setup development env
          # create normal user with sudo permission
          lxc exec ${VM} -- adduser --disabled-password --comment "" ${USERNAME_IN_LXC}
          lxc exec ${VM} -- adduser ${USERNAME_IN_LXC} sudo

          echo "======================================================"
          echo "The shell currently used in vm by ${USERNAME_IN_LXC}: "
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "echo ${SHELL}"
          echo "======================================================"

          #echo ${GITHUB_WORKSPACE}
          #ls ${GITHUB_WORKSPACE}
          #ls -alhd ${GITHUB_WORKSPACE}
          #echo ${REPO_NAME}
          lxc file push -r ${GITHUB_WORKSPACE} ${VM}/home/${USERNAME_IN_LXC}/
          #lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "ls ./"
          #lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "ls ${REPO_NAME}"
          #lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "pwd"

          lxc exec ${VM} -- ${HOME_IN_LXC}/${REPO_NAME}/debian/tools/func-setup-sudo-without-password.sh ${USERNAME_IN_LXC}

      - name: Get Ready to Setup Testbed with LXD and QEMU Tools
        run: |
          # begin to setup autopkgtest
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "${HOME_IN_LXC}/${REPO_NAME}/debian/tools/03-get-ready-to-use-autopkgtest-qemu-lxd.sh"

          # make sure USER can run lxd lxc without sudo
          lxc exec ${VM} -- snap services lxd
          # snap service prefix is snap.
          lxc exec ${VM} -- systemctl start snap.lxd.activate
          lxc exec ${VM} -- systemctl start snap.lxd.daemon
          lxc exec ${VM} -- systemctl start snap.lxd.user-daemon
          lxc exec ${VM} -- snap services lxd
          # hmmm this trick works rather than systemctl start
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "sudo usermod -a -G lxd ${USERNAME_IN_LXC}"
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "newgrp lxd"

          echo "checking /dev/kvm read/write permission..."
          lxc exec ${VM} -- apt update
          lxc exec ${VM} -- apt install -y cpu-checker
          lxc exec ${VM} -- kvm-ok
          lxc exec ${VM} -- adduser ${USERNAME_IN_LXC} kvm
          lxc exec ${VM} -- kvm-ok
          echo "checking /dev/kvm read/write permission... done!"

          # make sure USER can know the /snap/bin/lxd path
          # make sure USER can have lxd group permission
          echo "rebooting vm..."
          lxc exec ${VM} -- reboot
          sleep 30
          echo "rebooted vm."

          # get lxd-managed lxc command ready to use
          lxc exec ${VM} -- lxd init --auto

      - name: Build Deb
        run: |
          # build rasdaemon deb
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "${HOME_IN_LXC}/${REPO_NAME}/debian/tools/02-fetch-and-build-rasdaemon-deb-src.sh"

      - name: Run Test - Autopkgtest Local Env
        run: |
          # start testing with autopkgtest
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "${HOME_IN_LXC}/${REPO_NAME}/debian/tools/04-run-autopkgtest-local.sh"

      - name: Setup Testbed - Autopkgtest QEMU
        run: |
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "${HOME_IN_LXC}/${REPO_NAME}/debian/tools/03-get-ready-to-use-autopkgtest-qemu-lxd-01-setup-qemu-image.sh"

      - name: Run Test - Autopkgtest QEMU
        # rasdaemon autopkgtest has a known issue with QEMU based test.
        # See Bug#1071456 https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1071456
        # at this moment let us just ignore the failure until the kernel is updated.
        continue-on-error: true
        run: |
          lxc exec ${VM} -- su --login ${USERNAME_IN_LXC} -c "${HOME_IN_LXC}/${REPO_NAME}/debian/tools/04-run-autopkgtest-qemu.sh"

          echo
          echo "=================================================================================================================="
          echo "rasdaemon autopkgtest has a known issue with QEMU based test."
          echo "See Bug#1071456 https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1071456"
          echo
          echo "Dont worry if this step fail for timeout raised by 6.8 kernel in the QEMU VM instance."
          echo "=================================================================================================================="
          echo
